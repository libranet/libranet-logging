# Testing - Github Actions
#
# Security references:
#  - https://securitylab.github.com/resources/github-actions-preventing-pwn-requests
#  - https://securitylab.github.com/resources/github-actions-untrusted-input
#  - https://securitylab.github.com/resources/github-actions-building-blocks
#  - https://securitylab.github.com/resources/github-actions-new-patterns-and-mitigations
#
# Used actions:
#   - actions/checkout
#     repo: https://github.com/actions/checkout
#     releases: https://github.com/actions/checkout/tags
#
#   - astral-sh/setup-uv: set up uv environment
#     repo: https://github.com/astral-sh/setup-uv
#     releases: https://github.com/astral-sh/setup-uv/tags
#     docs: https://docs.astral.sh/uv/guides/integration/github/


name: Testing

# Limit concurrency by workflow/branch combination.
# For pull request builds, pushing additional changes to the branch will cancel prior in-progress and pending builds.
# For builds triggered on a branch push, additional changes will wait for prior builds to complete before starting.
# see https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
    # Enable colored output for pytest
    # https://github.com/pytest-dev/pytest/issues/7443
    # https://github.com/actions/runner/issues/241
    PY_COLORS: 1

on:
    pull_request:
        types: [opened, reopened, synchronize]
    push:
        branches:
            - main

permissions:
    contents: read

jobs:
    # see https://docs.astral.sh/uv/guides/integration/github/
    python-tests:
        name: python
        runs-on: ubuntu-latest
        timeout-minutes: 10

        strategy:
            fail-fast: false
            matrix:
                python-version:
                - "3.8"
                - "3.9"
                - "3.10"
                - "3.11"
                - "3.12"
                - "3.13"
                - "3.14"

        steps:

        # repo: https://github.com/actions/checkout
        # releases: https://github.com/actions/checkout/tags
        - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1 released on 02-12-2025
          with:
              persist-credentials: false
              fetch-depth: 0

        - name: Remove sitecustomize.py
          run: |
            sudo rm -f /usr/lib/python3.*/sitecustomize.py
            sudo rm -f /etc/python3.*/sitecustomize.py

        # repo: https://github.com/astral-sh/setup-uv
        # releases: https://github.com/astral-sh/setup-uv/tags
        # docs: https://docs.astral.sh/uv/guides/integration/github
        - name: Install the latest version of uv
          uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867  # v7.1.6 released on 13-12-2025
          with:
              python-version: ${{ matrix.python-version }}
              version: "latest"

        - name: Set up Python ${{ matrix.python-version }}
          run: uv python install ${{ matrix.python-version }}

        - name: Install the project
          run: uv sync --all-groups

        - name: Run tests
          run: uv run pytest tests --cov=src --cov-report html --cov-report xml --cov-report term -v

        # repo: https://github.com/codecov/codecov-action
        # releases: https://github.com/codecov/codecov-action/tags
        - name: "Upload coverage to Codecov"
          uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v5.5.2 released on 09-12-2025
          with:
              fail_ci_if_error: false  # optional (default = false)
              # files: var/coverage/coverage.xml  # optional
              directory: var/coverage
              flags: unittests # optional
              token: ${{ secrets.CODECOV_TOKEN }}  # not required for public repos
              verbose: true  # optional (default = false)
